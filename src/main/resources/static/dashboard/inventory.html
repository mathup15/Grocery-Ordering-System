<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>FreshCartLanka • Inventory</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }

        body { background-color: #f9fafb; color: var(--gray-900); line-height: 1.5; }
        .hidden { display: none !important; }

        /* Header Styles */
        .topbar { display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; background: white; box-shadow: var(--shadow);
            position: sticky; top: 0; z-index: 10; }

        .brand { display: flex; align-items: center; gap: 0.75rem; }
        .logo { display: flex; align-items: center; justify-content: center; width: 2.5rem; height: 2.5rem;
            background: var(--primary); color: white; font-weight: bold; border-radius: var(--radius); }
        h1 { font-size: 1.25rem; font-weight: 600; }
        .actions { display: flex; gap: 0.75rem; }

        /* Button Styles */
        .btn { padding: 0.5rem 1rem; border-radius: var(--radius); border: 1px solid transparent;
            font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; }
        .btn.primary { background: var(--primary); color: white; }
        .btn.primary:hover { background: var(--primary-dark); }
        .btn.ghost { background: transparent; border-color: var(--gray-300); color: var(--gray-700); }
        .btn.ghost:hover { background: var(--gray-100); }
        .btn.danger { background: var(--danger); color: white; }
        .btn.small { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Filter Styles */
        .filters { display: flex; gap: 1rem; padding: 1.5rem; background: white; margin: 1rem;
            border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; align-items: center; }
        .filters input, .filters select { padding: 0.5rem; border: 1px solid var(--gray-300);
            border-radius: var(--radius); background: white; }
        #q { flex: 1; min-width: 200px; }
        .check { display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }

        /* Main Content */
        main { padding: 0 1.5rem 2rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);
            transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .thumb { height: 160px; overflow: hidden; background: var(--gray-100); display: flex; align-items: center; justify-content: center; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .meta { padding: 1rem; }
        .meta h3 { font-size: 1.125rem; margin-bottom: 0.25rem; }
        .muted { color: var(--gray-500); font-size: 0.875rem; margin-bottom: 1rem; }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: 600; font-size: 1.125rem; margin-bottom: 0.25rem; }
        .gap { gap: 0.5rem; }
        .empty { text-align: center; padding: 3rem; color: var(--gray-500); }
        .pager { display: flex; justify-content: space-between; align-items: center; }

        /* Dialog Styles */
        dialog { border: none; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 0; width: 90%; max-width: 700px; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        .dlg-title { padding: 1.5rem 1.5rem 0; }
        .dlg-title h3 { font-size: 1.25rem; font-weight: 600; }
        .form { padding: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .col2 { grid-column: 1 / span 2; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300);
            border-radius: var(--radius); font-size: 1rem; }
        .hint { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }
        .preview { margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
        .dlg-actions { padding: 0 1.5rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* Stock Dialog Styles */
        .stock-info { padding: 1.5rem; border-bottom: 1px solid var(--gray-200); }
        .product-info { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .product-img { width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius); }
        .stock-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.875rem; color: var(--gray-500); }
        .stat-value { font-weight: 600; font-size: 1.125rem; }
        .stock-controls { padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }

        /* Image upload styles */
        .image-options { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .image-option { flex: 1; padding: 1rem; border: 1px solid var(--gray-300);
            border-radius: var(--radius); cursor: pointer; text-align: center; }
        .image-option.selected { border-color: var(--primary); background-color: rgba(16, 185, 129, 0.1); }

        /* Responsive */
        @media (max-width: 768px) {
            .filters { flex-direction: column; align-items: stretch; }
            .form { grid-template-columns: 1fr; }
            .col2 { grid-column: 1; }
            .stock-stats { grid-template-columns: 1fr; }
            .image-options { flex-direction: column; }
        }
    </style>
</head>
<body>
<header class="topbar">
    <div class="brand">
        <span class="logo">FC</span>
        <h1>FreshCart • Inventory</h1>
    </div>
    <div class="actions">
        <button id="btnExport" class="btn ghost">Export</button>
        <button id="btnImport" class="btn ghost">Import</button>
        <button id="btnAdd" class="btn primary">New Product</button>
    </div>
</header>

<section class="filters">
    <input id="q" type="search" placeholder="Search by name, SKU, category…"/>
    <select id="cat">
        <option value="">All Categories</option>
        <option value="Grocery">Grocery</option>
        <option value="Dairy">Dairy</option>
        <option value="Produce">Produce</option>
        <option value="Bakery">Bakery</option>
        <option value="Beverages">Beverages</option>
    </select>
    <select id="sort">
        <option value="name">Name</option>
        <option value="price">Price</option>
        <option value="stock">Stock</option>
        <option value="new">Newest</option>
    </select>
    <label class="check">
        <input id="lowOnly" type="checkbox"/> Low stock only
    </label>
</section>

<main>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty hidden">No products found. Add your first product!</div>
    <div class="pager">
        <p id="count">Showing 0 products</p>
        <div>
            <button id="prev" class="btn ghost" disabled>Prev</button>
            <button id="next" class="btn ghost" disabled>Next</button>
        </div>
    </div>
</main>

<!-- Product Dialog -->
<dialog id="dlg">
    <form id="form" method="dialog" enctype="multipart/form-data">
        <div class="dlg-title"><h3 id="dlgTitle">New Product</h3></div>
        <div class="grid form">
            <label> Name * <input name="name" required/> </label>
            <label> SKU * <input name="sku" required/> </label>
            <label> Category * <input name="category" required/> </label>
            <label> Brand <input name="brand"/> </label>
            <label> Unit * <input name="unit" placeholder="kg, pack, bottle" required/> </label>
            <label> Price (LKR) * <input name="price" type="number" min="0" step="0.01" required/> </label>
            <label> Stock Quantity * <input name="stock_quantity" type="number" min="0" step="1" value="0" required/> </label>
            <label> Reorder Point * <input name="reorder_point" type="number" min="0" step="1" value="10" required/> </label>
            <label> Reorder Quantity * <input name="reorder_quantity" type="number" min="0" step="1" value="50" required/> </label>
            <label> Inventory ID * <input name="inventory_id" type="number" min="1" value="1" required/> </label>
            <label> Status *
                <select name="active" required>
                    <option value="1" selected>Active</option>
                    <option value="0">Inactive</option>
                </select>
            </label>
            <div class="col2">
                <label> Description <textarea name="description" rows="3"></textarea> </label>
            </div>
            <div class="col2">
                <label> Expiry Date <input name="expiry_date" type="date"/> </label>
            </div>

            <div class="col2">
                <h4>Product Image</h4>
                <div class="image-options">
                    <div class="image-option selected" data-option="url">
                        <strong>Image URL</strong>
                        <p class="hint">Enter a web address</p>
                    </div>
                    <div class="image-option" data-option="upload">
                        <strong>Upload Image</strong>
                        <p class="hint">Select a file</p>
                    </div>
                </div>

                <div id="urlSection">
                    <label> Image URL <input name="image_url" type="url" placeholder="https://example.com/image.jpg"/> </label>
                </div>

                <div id="uploadSection" class="hidden">
                    <label> Image (upload file)
                        <input id="image" name="image" type="file" accept=".jpg,.jpeg,.png,.gif,.webp"/>
                    </label>
                    <div id="preview" class="preview hidden">
                        <img alt="preview"/><button id="clearImg" type="button" class="btn ghost small">Clear</button>
                    </div>
                    <p class="hint">Max 5MB. jpg, jpeg, png, gif, webp.</p>
                </div>
            </div>
        </div>
        <div class="dlg-actions">
            <button class="btn ghost" value="cancel">Cancel</button>
            <button class="btn primary" type="submit" value="save">Save</button>
        </div>
    </form>
</dialog>

<!-- Stock Management Dialog -->
<dialog id="stockDlg">
    <form id="stockForm" method="dialog">
        <div class="dlg-title"><h3>Manage Stock</h3></div>
        <div class="stock-info">
            <div class="product-info">
                <img id="stockProductImage" src="" alt="" class="product-img"/>
                <div>
                    <h4 id="stockProductName"></h4>
                    <p class="muted" id="stockProductSku"></p>
                    <p class="muted" id="stockProductCategory"></p>
                </div>
            </div>

            <div class="stock-stats">
                <div class="stat">
                    <span class="stat-label">Current Stock:</span>
                    <span class="stat-value" id="currentStock">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Reserved:</span>
                    <span class="stat-value" id="reservedQty">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Available:</span>
                    <span class="stat-value" id="availableQty">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Reorder Point:</span>
                    <span class="stat-value" id="reorderPoint">0</span>
                </div>
            </div>
        </div>

        <div class="stock-controls">
            <label>
                Adjustment Type
                <select id="adjustmentType" required>
                    <option value="ADD">Add Stock</option>
                    <option value="REMOVE">Remove Stock</option>
                    <option value="SET">Set Stock</option>
                </select>
            </label>

            <label>
                Quantity
                <input id="adjustmentQty" type="number" min="1" value="1" required/>
            </label>

            <label>
                Reason
                <input id="adjustmentReason" type="text" placeholder="Restock, Sale, Damage, etc." required/>
            </label>
        </div>

        <div class="dlg-actions">
            <button class="btn ghost" value="cancel">Cancel</button>
            <button class="btn primary" value="save">Update Stock</button>
        </div>
    </form>
</dialog>

<input id="csv" type="file" accept=".csv" class="hidden"/>
<template id="tpl">
    <div class="card">
        <div class="thumb"><img/></div>
        <div class="meta">
            <h3></h3>
            <p class="muted"><span class="sku"></span> • <span class="cat"></span></p>
            <div class="row">
                <div>
                    <div class="price"></div>
                    <div class="muted"><span class="stock"></span> in stock</div>
                </div>
                <div class="row gap">
                    <button class="btn ghost btn-edit">Edit</button>
                    <button class="btn primary btn-stock">Stock</button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    /* ===== ONLY MAPPING LOGIC CHANGED BELOW (UI/CSS kept exactly) ===== */

    /* --- Auth header from your login token --- */
    function authHeaders(){
        const t = localStorage.getItem('auth.token');
        return t ? { Authorization: `Bearer ${t}` } : {};
    }

    /* --- API endpoints (match your Spring controller) --- */
    const API = {
        list: "/api/inventory/products",
        create: "/api/inventory/products",
        update: id => `/api/inventory/products/${id}`,
        export: "/api/inventory/reports/low-stock",
        adjust: id => `/api/inventory/stock/${id}/adjust`,
    };

    /* DOM elements (unchanged) */
    const dlg = document.getElementById('dlg');
    const form = document.getElementById('form');
    const stockDlg = document.getElementById('stockDlg');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const tpl = document.getElementById('tpl');
    const btnAdd = document.getElementById('btnAdd');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const count = document.getElementById('count');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const q = document.getElementById('q');
    const cat = document.getElementById('cat');
    const sort = document.getElementById('sort');
    const lowOnly = document.getElementById('lowOnly');
    const urlSection = document.getElementById('urlSection');
    const uploadSection = document.getElementById('uploadSection');
    const imageOptions = document.querySelectorAll('.image-option');

    /* State (front-end pagination mirrors server pagination) */
    let currentPage = 1;
    const itemsPerPage = 6;
    let editingId = null;
    let currentProduct = null;
    let uploadedImageData = null;

    /* Data from server */
    let products = [];       // current page items mapped for UI
    let serverTotal = 0;     // total items count on server
    let serverRaw = [];      // raw objects from server (for edit/stock)

    /* Initialize */
    document.addEventListener('DOMContentLoaded', init);

    function init() {
        renderSkeletons();
        setupEventListeners();
        loadFromServer(); // initial fetch
    }

    function setupEventListeners() {
        // Add product
        btnAdd.addEventListener('click', () => {
            editingId = null;
            form.reset();
            document.getElementById('dlgTitle').textContent = 'New Product';
            selectImageOption('url');
            uploadedImageData = null;
            dlg.showModal();
        });

        // Save product -> backend
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            saveProductToServer();
        });

        // Filters -> refetch from server
        q.addEventListener('input', debounce(() => { currentPage = 1; loadFromServer(); }, 300));
        cat.addEventListener('change', () => { currentPage = 1; loadFromServer(); });
        sort.addEventListener('change', () => { currentPage = 1; loadFromServer(); });
        lowOnly.addEventListener('change', () => { currentPage = 1; loadFromServer(); });

        // Pagination -> fetch next/prev page
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; loadFromServer(); }
        });
        nextBtn.addEventListener('click', () => {
            const totalPages = Math.max(1, Math.ceil(serverTotal / itemsPerPage));
            if (currentPage < totalPages) { currentPage++; loadFromServer(); }
        });

        // Export/Import
        btnExport.addEventListener('click', exportFromServer);
        btnImport.addEventListener('click', () => document.getElementById('csv').click());
        document.getElementById('csv').addEventListener('change', () => {
            alert('Import placeholder — hook to /api/inventory/csv/import if needed.');
        });

        // Image option selection
        imageOptions.forEach(option => {
            option.addEventListener('click', () => {
                selectImageOption(option.dataset.option);
            });
        });

        // Image upload preview
        document.getElementById('image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImageData = event.target.result;
                    const preview = document.getElementById('preview');
                    preview.querySelector('img').src = uploadedImageData;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Clear image
        document.getElementById('clearImg').addEventListener('click', function() {
            document.getElementById('image').value = '';
            document.getElementById('preview').classList.add('hidden');
            uploadedImageData = null;
        });

        // Stock form -> backend
        document.getElementById('stockForm').addEventListener('submit', onApplyStockServer);
    }

    /* Image option UI */
    function selectImageOption(option) {
        imageOptions.forEach(opt => opt.classList.toggle('selected', opt.dataset.option === option));
        if (option === 'url') { urlSection.classList.remove('hidden'); uploadSection.classList.add('hidden'); }
        else { urlSection.classList.add('hidden'); uploadSection.classList.remove('hidden'); }
    }

    /* Normalize sort value for backend */
    function mapSortValue() {
        const v = sort.value || 'name';
        if (v === 'new') return 'new';  // mapped in backend to id DESC
        if (v === 'price') return 'price';
        // backend may not support "stock" sort; fallback to name
        return 'name';
    }

    /* Load from server */
    async function loadFromServer(){
        try{
            renderSkeletons();
            const url = new URL(API.list, location.origin);
            url.searchParams.set('page', String(currentPage - 1));
            url.searchParams.set('size', String(itemsPerPage));
            if (q.value.trim()) url.searchParams.set('q', q.value.trim());
            if (cat.value) url.searchParams.set('category', cat.value);
            url.searchParams.set('sort', mapSortValue());
            if (lowOnly.checked) url.searchParams.set('lowOnly', 'true');

            const res = await fetch(url, { headers: { ...authHeaders() } });
            if (!res.ok) throw new Error(`Load failed (${res.status})`);
            const data = await res.json();

            const items = data.items || data.content || [];
            serverTotal = Number(data.total || data.totalElements || items.length) || 0;
            serverRaw = items;

            // map to view objects expected by your template
            products = items.map(toViewProduct);

            renderProductsServer();
        }catch(err){
            grid.innerHTML = `<div class="muted">Error loading products: ${err.message}</div>`;
            empty.classList.add('hidden');
            // (optional) keep UI usable if backend down – leave as is
        }
    }

    /* Map backend ProductResp -> view model used by this page */
    function toViewProduct(p){
        const soh = Number(p.stockOnHand ?? 0);
        const res = Number(p.reservedQty ?? 0);
        const avail = Number(p.availableQty ?? Math.max(0, soh - res));
        return {
            id: p.id,
            name: p.name,
            sku: p.sku,
            category: p.category || '',
            brand: '', // not provided by backend
            unit: p.unit || '',
            price: Number(p.price || 0),
            stock_quantity: avail,
            reorder_point: Number(p.reorderPoint || 0),
            reorder_quantity: 0,
            inventory_id: 0,
            active: p.active ? 1 : 0,
            description: '',
            image_url: p.imageUrl || '',
            image_data: '',
            // keep raw stock numbers for stock dialog math
            _soh: soh,
            _res: res,
            _avail: avail
        };
    }

    /* Render grid using server page */
    function renderProductsServer(){
        grid.innerHTML = '';
        if (products.length === 0) {
            empty.classList.remove('hidden');
            count.textContent = 'Showing 0 products';
        } else {
            empty.classList.add('hidden');
            products.forEach(product => { grid.appendChild(createProductElement(product)); });
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(start + products.length - 1, serverTotal);
            count.textContent = `Showing ${start}-${end} of ${serverTotal} products`;
        }
        const totalPages = Math.max(1, Math.ceil(serverTotal / itemsPerPage));
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
    }

    /* Card creation (unchanged, uses mapped view fields) */
    function createProductElement(product) {
        const el = tpl.content.cloneNode(true);
        const card = el.querySelector('.card');
        card.dataset.id = product.id;

        const img = el.querySelector('.thumb img');
        if (product.image_data) img.src = product.image_data;
        else if (product.image_url) img.src = product.image_url;
        else img.src = 'https://via.placeholder.com/300x150?text=No+Image';
        img.alt = product.name;

        el.querySelector('h3').textContent = product.name;
        el.querySelector('.sku').textContent = product.sku;
        el.querySelector('.cat').textContent = product.category;
        el.querySelector('.price').textContent = `LKR ${product.price.toFixed(2)}`;

        const stockEl = el.querySelector('.stock');
        stockEl.textContent = product.stock_quantity;
        if (product.stock_quantity === 0) { stockEl.style.color = 'var(--danger)'; stockEl.style.fontWeight = 'bold'; }
        else if (product.stock_quantity <= product.reorder_point) { stockEl.style.color = 'var(--warning)'; stockEl.style.fontWeight = 'bold'; }

        el.querySelector('.btn-edit').addEventListener('click', () => {
            editingId = product.id;
            document.getElementById('dlgTitle').textContent = 'Edit Product';
            fillForm(product);
            dlg.showModal();
        });

        el.querySelector('.btn-stock').addEventListener('click', () => {
            currentProduct = product;
            showStockDialog(product);
        });

        return el;
    }

    function fillForm(product) {
        form.querySelector('[name="name"]').value = product.name;
        form.querySelector('[name="sku"]').value = product.sku;
        form.querySelector('[name="category"]').value = product.category;
        form.querySelector('[name="brand"]').value = product.brand || '';
        form.querySelector('[name="unit"]').value = product.unit;
        form.querySelector('[name="price"]').value = product.price;
        form.querySelector('[name="stock_quantity"]').value = product.stock_quantity; // for reference only
        form.querySelector('[name="reorder_point"]').value = product.reorder_point;
        form.querySelector('[name="reorder_quantity"]').value = product.reorder_quantity;
        form.querySelector('[name="inventory_id"]').value = product.inventory_id;
        form.querySelector('[name="active"]').value = product.active;
        form.querySelector('[name="description"]').value = product.description || '';
        form.querySelector('[name="expiry_date"]').value = product.expiry_date || '';

        // Prefer URL mode; user can switch to Upload if they want to replace
        selectImageOption('url');
        form.querySelector('[name="image_url"]').value = product.image_url || '';

        document.getElementById('image').value = '';
        document.getElementById('preview').classList.add('hidden');
    }

    /* Save (create/update) mapped to backend */
    async function saveProductToServer() {
        // collect minimal fields backend expects
        const sku = form.querySelector('[name="sku"]').value.trim();
        const name = form.querySelector('[name="name"]').value.trim();
        const category = form.querySelector('[name="category"]').value.trim();
        const unit = form.querySelector('[name="unit"]').value.trim();
        const price = Number(form.querySelector('[name="price"]').value || 0);
        const reorderPoint = Number(form.querySelector('[name="reorder_point"]').value || 0);

        if (!sku || !name || price < 0) { alert('Please fill required fields.'); return; }

        const useUrl = document.querySelector('.image-option.selected')?.dataset.option === 'url';
        const file = document.getElementById('image').files?.[0];
        const imageUrl = form.querySelector('[name="image_url"]').value.trim();

        let method = editingId ? 'PUT' : 'POST';
        let url = editingId ? API.update(editingId) : API.create;

        try{
            let res;
            if (!useUrl && file) {
                // multipart
                const fd = new FormData();
                fd.append('sku', sku);
                fd.append('name', name);
                if (category) fd.append('category', category);
                if (unit) fd.append('unit', unit);
                fd.append('price', String(price));
                fd.append('reorderPoint', String(reorderPoint));
                fd.append('image', file);
                res = await fetch(url, { method, headers: { ...authHeaders() }, body: fd });
            } else {
                // JSON
                const body = { sku, name, category, unit, price, reorderPoint, imageUrl: imageUrl || null };
                res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(body)
                });
            }

            if (!res.ok) {
                const msg = await safeError(res);
                throw new Error(msg || `Save failed (${res.status})`);
            }

            dlg.close();
            loadFromServer();
        }catch(err){ alert(err.message); }
    }

    /* Stock dialog rendering (uses mapped fields) */
    function showStockDialog(product) {
        document.getElementById('stockProductName').textContent = product.name;
        document.getElementById('stockProductSku').textContent = product.sku;
        document.getElementById('stockProductCategory').textContent = product.category;

        const img = document.getElementById('stockProductImage');
        if (product.image_data) { img.src = product.image_data; img.style.display = 'block'; }
        else if (product.image_url) { img.src = product.image_url; img.style.display = 'block'; }
        else { img.style.display = 'none'; }

        // real values from backend mapping
        document.getElementById('currentStock').textContent = product._soh;
        document.getElementById('reservedQty').textContent = product._res;
        document.getElementById('availableQty').textContent = product._avail;
        document.getElementById('reorderPoint').textContent = product.reorder_point;

        stockDlg.showModal();
    }

    /* Apply stock -> backend adjust; maps ADD/REMOVE/SET to IN/OUT/ADJUST (SET computed delta) */
    async function onApplyStockServer(e){
        e.preventDefault();
        if (!currentProduct) { stockDlg.close(); return; }

        const typeSel = document.getElementById('adjustmentType').value;
        const qtyInput = Number(document.getElementById('adjustmentQty').value || 0);
        const note = document.getElementById('adjustmentReason').value || 'MANUAL';

        if (qtyInput <= 0) { alert('Quantity must be > 0'); return; }

        // Map types
        let payload = { type: 'IN', qty: qtyInput, note };
        if (typeSel === 'ADD') payload.type = 'IN';
        else if (typeSel === 'REMOVE') payload.type = 'OUT';
        else if (typeSel === 'SET') {
            // compute delta vs current stock-on-hand (not available)
            const soh = Number(currentProduct._soh || 0);
            if (qtyInput === soh) { stockDlg.close(); return; }
            if (qtyInput > soh) { payload.type = 'IN'; payload.qty = qtyInput - soh; }
            else { payload.type = 'OUT'; payload.qty = soh - qtyInput; }
        }

        try{
            const res = await fetch(API.adjust(currentProduct.id), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const msg = await safeError(res);
                throw new Error(msg || `Adjust failed (${res.status})`);
            }
            stockDlg.close();
            loadFromServer();
        }catch(err){ alert(err.message); }
    }

    /* Export CSV from backend */
    async function exportFromServer(){
        try{
            const res = await fetch(API.export, { headers: { ...authHeaders() }});
            if (!res.ok) throw new Error(`Export failed (${res.status})`);
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `low-stock-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }catch(err){ alert(err.message); }
    }

    /* Helpers */
    function renderSkeletons(){
        grid.innerHTML = Array.from({length: itemsPerPage}).map(()=>`
    <div class="card"><div class="thumb"></div><div class="meta"><div class="muted">Loading…</div></div></div>
  `).join('');
        empty.classList.add('hidden');
    }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    async function safeError(res){
        try{ const t = await res.text(); try{ const j=JSON.parse(t); return j.error||j.message||t; }catch{ return t; } }
        catch{ return ''; }
    }

</script>
</body>
</html>
